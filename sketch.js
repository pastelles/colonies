/*let colorPalettes = [
  { name: "Sunset Horizon", colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FDCB6E', '#6C5CE7'] },
  { name: "Forest Whisper", colors: ['#2D3E4E', '#537A5A', '#9ECE9A', '#DAD7CD', '#4A5859'] },
  { name: "Urban Rhythm", colors: ['#2B2D42', '#8D99AE', '#EDF2F4', '#EF233C', '#D90429'] },
  { name: "Pastel Dream", colors: ['#FFD3B6', '#FFAAA5', '#FF8B94', '#DCEDC1', '#A8E6CF'] },
  { name: "Neon Nights", colors: ['#3E1F47', '#5C2A9D', '#8D5FD3', '#14F195', '#00E3CC'] },
  { name: "Autumn Breeze", colors: ['#D8B384', '#E7DFC6', '#9C7C38', '#6E4C1E', '#3A3238'] },
  { name: "Ocean Depths", colors: ['#05445E', '#189AB4', '#75E6DA', '#D4F1F4', '#0A1931'] },
  { name: "Electric Pop", colors: ['#F72585', '#7209B7', '#3A0CA3', '#4361EE', '#4CC9F0'] },
  { name: "Earthy Tones", colors: ['#606C38', '#283618', '#DDA15E', '#BC6C25', '#FEFAE0'] },
  // New vibrant palettes
  { name: "Tropical Punch", colors: ['#FF1493', '#FF4500', '#FFD700', '#00FF00', '#00FFFF'] },
  { name: "Candy Explosion", colors: ['#FF00FF', '#00FFFF', '#FF1493', '#FFFF00', '#FF69B4'] },
  { name: "Neon Carnival", colors: ['#39FF14', '#FF3131', '#FF00FF', '#00FFFF', '#FFFF00'] },
  { name: "Vibrant Sunset", colors: ['#FF4E50', '#FC913A', '#F9D62E', '#8DE969', '#00FFFF'] },
  { name: "Rainbow Burst", colors: ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF'] },

]; */
/*let colorPalettes = [
  { name: "Vibrant Rainbow", colors: ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF'] },
  { name: "Pastel Serenity", colors: ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF'] },
  { name: "Monochrome Elegance", colors: ['#000000', '#333333', '#666666', '#999999', '#FFFFFF'] },
  { name: "Neon Nights", colors: ['#FF00FF', '#00FFFF', '#FF00AA', '#AA00FF', '#00FF00'] },
  { name: "Earthy Tones", colors: ['#5D4037', '#795548', '#A1887F', '#BCAAA4', '#D7CCC8'] },
  { name: "Ocean Depths", colors: ['#000080', '#0000FF', '#1E90FF', '#00FFFF', '#E0FFFF'] },
  { name: "Autumn Harvest", colors: ['#8B4513', '#CD853F', '#DEB887', '#D2691E', '#FFDAB9'] },
  { name: "Retro Pop", colors: ['#FF69B4', '#FF6347', '#FFD700', '#00CED1', '#9370DB'] },
  { name: "Muted Sophistication", colors: ['#2F4F4F', '#708090', '#778899', '#B0C4DE', '#F0F8FF'] },
  { name: "Tropical Paradise", colors: ['#00A86B', '#FDBE02', '#FF4F58', '#0089A7', '#F7EF81'] }
];*/
let colorPalettes = [
  { name: "Coral Reef", colors: ['#FF6B6B', '#4ECDC4', '#45B7D1'] },
  { name: "Summer Breeze", colors: ['#F38181', '#FCE38A', '#EAFFD0'] },
  { name: "Twilight Haze", colors: ['#6A0572', '#AB83A1', '#F7EF99'] },
  { name: "Urban Contrast", colors: ['#2C3E50', '#E74C3C', '#ECF0F1'] },
  { name: "Ocean Depths", colors: ['#021B79', '#0575E6', '#205E9B'] },
  { name: "Autumn Leaves", colors: ['#FF6F61', '#6B4226', '#F0E4D7'] },
  { name: "Mint Fresh", colors: ['#98FF98', '#3B9C9C', '#0CABA8'] },
  { name: "Sunset Glow", colors: ['#FF7E5F', '#FEB47B', '#FFB347'] },
  { name: "Vintage Chic", colors: ['#D9B8C4', '#94858D', '#594A4E'] },
  { name: "Rustic Charm", colors: ['#A52A2A', '#DEB887', '#D2B48C'] },
  { name: "Cool Waves", colors: ['#5DADE2', '#2874A6', '#154360'] },
  { name: "Spring Meadow", colors: ['#77DD77', '#FDFD96', '#FFD700'] },
  { name: "Berry Bliss", colors: ['#8A2BE2', '#BA55D3', '#E6E6FA'] },
  { name: "Midnight Forest", colors: ['#1C1C1C', '#2E8B57', '#556B2F'] },
  { name: "Lavender Dreams", colors: ['#E6E6FA', '#D8BFD8', '#9370DB'] },
  { name: "Fiery Passion", colors: ['#FF4500', '#DC143C', '#B22222'] },
  { name: "Golden Sands", colors: ['#FFD700', '#FFEC8B', '#F5DEB3'] },
  { name: "Peacock Feathers", colors: ['#20B2AA', '#4682B4', '#000080'] },
  { name: "Citrus Splash", colors: ['#FFA500', '#FFD700', '#ADFF2F'] },
  { name: "Rose Garden", colors: ['#FFC0CB', '#FF69B4', '#DB7093'] },
  { name: "Retro Pop", colors: ['#FF69B4', '#FF6347', '#FFD700', '#00CED1', '#9370DB'] },
  { name: "Pastel Serenity", colors: ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF'] },
  { name: "Neon Nights", colors: ['#FF00FF', '#00FFFF', '#FF00AA', '#AA00FF', '#00FF00'] }, 
];

/*let bgColors = [
  //{name: 'Ivory', bg: ['#FFFFF0']},
  //{name: 'Light Gray', bg: ['#D3D3D3']},
  //{name: 'Charcoal', bg: ['#36454F']},
  //{name: 'Beige', bg: ['#F5F5DC']},
  //{name: 'Navy', bg: ['#000080']},
  //{name: 'Sage', bg: ['#87AE73']},
  {name: 'Pale Pink', bg: ['#FADADD']},
  {name: 'Pale Blue', bg: ['#E4F6F8']},
  {name: 'Cream', bg: ['#FEFBEA']},
  {name: 'Black', bg: ['#000000']},
  {name: 'White', bg: ['#FFFFFF']},
];*/
let bgColors = [
  {name: 'Pale Pink', bg: ['#FADADD']},
  {name: 'Cream', bg: ['#FEFBEA']},
  {name: 'Black', bg: ['#000000']},
  {name: 'White', bg: ['#FFFFFF']},
];

let selectedPalette;
let selectedBackground;
let minDiameterRatio = 0.0001;
let maxDiameterRatio = 0.01;
let canvas;
let amplitudeRatio;
let frequencyRatio;
let renderProgress = 0;
let glitchElements = [];
let noiseIntensity = 1;
let glitches;

function setup() {
  let container = select('#canvas-container');
  let size = min(container.width, container.height * 0.8);
  canvas = createCanvas(size, size * 5/4);
  canvas.parent(container);
  pixelDensity(5);
//  amplitudeRatio = 1; // controlled, controlled, controlled, messy, splatter, splatter
  amplitudeRatio = hl.randomElement([0.002, 0.005, 0.01, 0.1, 0.5, 1]); // controlled, controlled, controlled, messy, splatter, splatter
  frequencyRatio = hl.randomElement([100, 150, 200, 300, 500]);

  selectedPalette = hl.randomElement(colorPalettes);
  selectedBackground = hl.randomElement(bgColors);

  background(selectedBackground.bg);
  addFinalNoise();
  noStroke();

  prepareGlitchElements();
  
  setTraits();
  
  loop();
}

function draw() {
  if (renderProgress < height) {
    drawAnimatedArtwork();
  } else if (glitchElements.length > 0) {
    drawGlitchElements();
  } else {
    addFinalNoise();
    noLoop();
  }
}

function drawAnimatedArtwork() {
  let minDiameter = width * minDiameterRatio;
  let maxDiameter = width * maxDiameterRatio;
  
  let y = renderProgress;
  let lineColor = color(hl.randomElement(selectedPalette.colors));
  fill(lineColor);
  
  let x = 0;
  let amplitude = width * amplitudeRatio;
  let frequency = frequencyRatio / width;
  
  while (x < width) {
    let lineLength = hl.random(width * 0.1, width * 0.5);
    let endX = min(x + lineLength, width);
    
    for (let dotX = x; dotX < endX; dotX += maxDiameter * 0.8) {
      let oscillation = sin(dotX * frequency) * amplitude;
      let yPos = y + oscillation;
      let diameter = hl.random(minDiameter, maxDiameter);
      circle(dotX, yPos, diameter);
    }
    
    x = endX;
  }
  
  renderProgress += maxDiameter * 0.8;
}

function prepareGlitchElements() {
  //glitches = 1000;
  glitches = hl.randomElement([50, 150, 200, 400]);
  for (let i = 0; i < glitches; i++) {
    glitchElements.push({
      x: hl.random(width),
      y: hl.random(height),
      w: hl.random(width * 0.03, width * 0.2),
      h: hl.random(height * 0.02, height * 0.1),
      color: color(hl.randomElement(selectedPalette.colors)),
      alpha: hl.randomElement([50, 100, 250, 500])
    });
  }
}

function drawGlitchElements() {
  let minDiameter = width * minDiameterRatio;
  let maxDiameter = width * maxDiameterRatio;
  
  let glitch = glitchElements.pop();
  let glitchColor = glitch.color;
  glitchColor.setAlpha(glitch.alpha);
  fill(glitchColor);
  
  for (let dotX = glitch.x; dotX < glitch.x + glitch.w; dotX += maxDiameter * 0.6) {
    for (let dotY = glitch.y; dotY < glitch.y + glitch.h; dotY += maxDiameter * 0.6) {
      let diameter = hl.random(minDiameter, maxDiameter);
      circle(dotX, dotY, diameter);
    }
  }
}

function addFinalNoise() {
  loadPixels();
  let d = pixelDensity();
  
  for (let x = 0; x < width; x++) {
    for (let y = 0; y < height; y++) {
      let index = 4 * (y * width * sq(d) + x * d);
      
      pixels[index] = constrain(pixels[index] + random(-noiseIntensity * 255, noiseIntensity * 255), 0, 255);
      pixels[index + 1] = constrain(pixels[index + 1] + random(-noiseIntensity * 255, noiseIntensity * 255), 0, 255);
      pixels[index + 2] = constrain(pixels[index + 2] + random(-noiseIntensity * 255, noiseIntensity * 255), 0, 255);
    }
  }
  
  updatePixels();
}

function windowResized() {
  pixelDensity(5);
  let container = select('#canvas-container');
  let size = min(container.width, container.height * 0.8);
  resizeCanvas(size, size * 5/4);
  background(selectedBackground.bg);
  renderProgress = 0;
  prepareGlitchElements();
  loop();
}

function setTraits() {
  const traits = {
    Palette: selectedPalette.name,
    Background: selectedBackground.name,
    Amplitude: amplitudeRatio <= 0.01 ? "Controlled" :
               amplitudeRatio <= 0.5 ? "Messy" : "Splatter",
    Frequency: frequencyRatio,
    Glitch: glitches === 50 ? "Sparse" :
            glitches === 150 ? "Normal" :
            glitches === 200 ? "Dense" : "Crowded",
  };

  hl.token.setTraits(traits);
      
  hl.token.setName(`Colonies #${hl.tx.tokenId}`);
  hl.token.setDescription(
    `Colonies by Pastelle
    Minted by ${hl.tx.walletAddress}.`
  );

  // Add these lines to update the features box and hash
  updateFeatures(traits);
  updateHash(hl.tx.hash);
}

function capturePreview() {
  let canvasElement = document.querySelector('#canvas-container canvas');
  
  if (canvasElement) {
    let dataURL = canvasElement.toDataURL();
    let event = new CustomEvent('CAPTURE_PREVIEW', { detail: dataURL });
    window.dispatchEvent(event);
  }
}